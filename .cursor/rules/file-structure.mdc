---
alwaysApply: true
---

# Flight School Marketplace — Cursor Rules (Revised)

## Project Goal (MVP)

A marketplace where students can **search, compare, and contact** flight schools; schools can **claim + manage** profiles; admins can **operate the crawl/normalize pipeline** and moderate data.

---

## Tech Stack (Locked)

- **Framework:** Next.js (App Router) + **TypeScript (strict)**
- **API:** tRPC v10 for interactive calls; REST route handlers for workers/cron
- **DB/ORM:** Postgres (Neon/Supabase) + Drizzle ORM + `pgvector`
- **Crawl/Extract:** Firecrawl API
- **Validation:** Zod
- **Auth:** next-auth (Auth.js) + Postgres adapter
- **UI:** Tailwind + shadcn/ui
- **LLM (debrief only):** Vercel AI SDK (OpenAI-compatible)

---

## Global Rules

- Assume dev server is running; **do not** add scripts to start it.
- **No `any`**; strict TS; keep files **≤ 350 LoC**.
- **Types** in `/types`, **helpers** in `/lib`.
- **All inputs validated with Zod**; mutations **auth-guarded**.
- **RBAC**: roles = `user | school | admin`; protect `/admin/**` for `admin`, `/portal/**` for `school`.
- Workers/cron stay as **REST routes**; interactive UI uses **tRPC**.
- **Append-only facts** with `provenance` + `as_of`; user-visible data must show an as-of or source.
- Use **pnpm** only.

---

## Information Architecture (routes & flow)

### Public / Marketplace

- **/** — Landing (search bar + featured schools)
- **/search** — Results with filters (URL-synced), list + (optional) map
- **/schools/[id]** — School profile (facts + Evidence Panel + Tier badge + Contact/Financing CTAs)
- **/compare** — Compare up to 4 schools (table of key facts)
- **/saved** — User’s saved schools
- **/claim** — Start claim flow (also reachable from school profile)

### Auth

- **/sign-in**, **/sign-out**

### Partner (School) Portal

- **/portal** — Overview (status, completeness)
- **/portal/profile** — Edit profile (proposed facts → moderation)
- **/portal/leads** — Inbound leads (from contact form)
- **/portal/analytics** — Views, CTR, match appearances (stub ok)

### Admin (Data Ops + Moderation)

- **/admin** — Overview dashboard
- **/admin/seeds**, **/admin/dedupe**, **/admin/queue**, **/admin/snapshots**
- **/admin/facts** (moderation), **/admin/signals**, **/admin/match-tester**

---

## File Structure (route groups + RBAC)

```text
.
├── app/
│   ├── (public)/
│   │   ├── page.tsx                          # Landing
│   │   ├── search/page.tsx                   # Results + filters (URL state)
│   │   ├── saved/page.tsx                    # Saved schools
│   │   └── compare/page.tsx                  # Compare table
│   ├── (marketplace)/
│   │   └── schools/[id]/page.tsx             # School profile
│   ├── (auth)/
│   │   └── sign-in/page.tsx
│   ├── admin/                                # ROLE: admin
│   │   ├── layout.tsx                        # admin nav + guard
│   │   ├── page.tsx                          # redirects to /admin/overview
│   │   ├── overview/page.tsx                 # overview dashboard
│   │   ├── seeds/page.tsx
│   │   ├── dedupe/page.tsx
│   │   ├── queue/page.tsx
│   │   ├── snapshots/page.tsx
│   │   ├── facts/page.tsx
│   │   ├── signals/page.tsx
│   │   └── match-tester/page.tsx
│   ├── portal/                               # ROLE: school
│   │   ├── layout.tsx                        # portal nav + guard
│   │   ├── page.tsx                          # overview
│   │   ├── profile/page.tsx
│   │   ├── leads/page.tsx
│   │   └── analytics/page.tsx
│   ├── claim/
│   │   ├── page.tsx
│   │   ├── verify/page.tsx
│   │   └── edit/page.tsx
│   ├── 403/
│   │   └── page.tsx                          # Forbidden page
│   ├── api/
│   │   ├── health/db/route.ts
│   │   ├── crawl/enqueue/route.ts
│   │   ├── crawl/worker/route.ts
│   │   ├── normalize/run/route.ts
│   │   ├── match/route.ts
│   │   ├── claim/request/route.ts
│   │   ├── claim/verify/route.ts
│   │   ├── claim/edit/route.ts
│   │   ├── embeddings/generate/route.ts
│   │   ├── refresh/run/route.ts
│   │   ├── financing/intent/route.ts
│   │   └── trpc/[trpc]/route.ts              # tRPC handler
│   ├── layout.tsx
│   └── globals.css
├── components/
│   ├── ui/*                                  # shadcn
│   ├── marketplace/
│   │   ├── SearchFilters.tsx
│   │   ├── ResultsList.tsx
│   │   ├── CompareTable.tsx
│   │   └── SaveButton.tsx
│   ├── schools/
│   │   ├── EvidencePanel.tsx
│   │   ├── TierBadge.tsx
│   │   └── ContactForm.tsx
│   ├── portal/
│   │   ├── PortalNav.tsx
│   │   ├── LeadRow.tsx
│   │   └── ProfileCompleteness.tsx
│   └── admin/
│       ├── AdminNav.tsx
│       ├── DedupeClusterCard.tsx
│       ├── FactModerationRow.tsx
│       ├── QueueRetryButton.tsx
│       ├── SeedResolverButton.tsx
│       ├── SignalsEditDialog.tsx
│       └── SnapshotViewer.tsx
├── lib/
│   ├── db.ts
│   ├── auth.ts                                # next-auth
│   ├── rbac.ts                                # hasRole(user, 'admin'|'school')
│   ├── middleware.ts                          # helpers used by layouts
│   ├── resolver.ts
│   ├── dedupe.ts
│   ├── firecrawl.ts
│   ├── normalize.ts
│   ├── embeddings.ts
│   ├── validation.ts
│   ├── utils.ts
│   ├── email.ts
│   ├── signals.ts
│   ├── refresh.ts
│   └── trpc/
│       ├── client.ts
│       ├── context.ts
│       ├── provider.tsx
│       └── trpc.ts
├── server/
│   └── routers/
│       ├── _app.ts
│       ├── marketplace.ts                     # search/list/compare/saved TRPC
│       ├── schools.ts                         # read profile, contact lead
│       ├── portal.ts                          # school-facing mutations/reads
│       ├── admin.ts                           # admin ops
│       ├── crawl-queue.ts
│       ├── snapshots.ts
│       ├── facts.ts
│       ├── seeds.ts
│       └── signals.ts
├── db/
│   ├── schema/
│   │   ├── index.ts
│   │   ├── seeds.ts
│   │   ├── schools.ts
│   │   ├── sources.ts
│   │   ├── snapshots.ts
│   │   ├── facts.ts
│   │   ├── crawl_queue.ts
│   │   ├── embeddings.ts
│   │   ├── signals_mock.ts
│   │   ├── claims.ts
│   │   ├── events_financing.ts
│   │   ├── leads.ts                           # NEW: marketplace contact leads
│   │   ├── saved_schools.ts                   # NEW: user favorites
│   │   ├── comparisons.ts                     # NEW: compare sets
│   │   └── user_profiles.ts                   # NEW: role, prefs
│   └── migrations/
├── types/
│   └── index.ts
├── hooks/
│   └── use-mobile.ts
├── middleware.ts                               # Next.js matcher: gate /admin, /portal
├── next-env.d.ts
└── .env.example
```

> **Route groups vs folders:** Route groups like `(public)`, `(marketplace)`, and `(auth)` organize routes with shared layouts **without adding URL segments**. Regular folders like `admin/`, `portal/`, and `claim/` create actual URL paths (`/admin`, `/portal`, `/claim`). Both approaches use layouts with server-side RBAC guards for protection.

---

## New DB tables (minimal marketplace add)

- `leads`: `id, school_id, user_id?, payload_json, created_at`
- `saved_schools`: `user_id, school_id, created_at` (PK: user_id+school_id)
- `comparisons`: `user_id, school_ids text[], created_at`
- `user_profiles`: `user_id, role enum('user','school','admin'), prefs_json, created_at, updated_at`

_(Keep existing crawl/facts/snapshots untouched.)_

---

## tRPC surface (by domain)

- **marketplace**: `search.query`, `saved.list`, `saved.toggle`, `compare.get`, `compare.set`
- **schools**: `get.byId`, `lead.create`, `financing.intent`
- **portal** (ROLE: school): `profile.get`, `profile.proposeFacts`, `leads.list`
- **admin** (ROLE: admin): `facts.moderate`, `signals.set`, `seeds.list`, `dedupe.run`, `queue.list/retry`, `snapshots.get`

All **mutations** must check session **and role**.

---

## UX Flow Notes

- **Search/Filters:** push filter state to URL (SSR-able for SEO on `/search`).
- **Compare:** store selections client-side; persist via `comparisons` on sign-in.
- **Saved:** optimistic toggle via tRPC mutation; hydrate on page load.
- **Contact (lead):** on `/schools/[id]`, post a Zod-validated form → `leads` row; show school confirmation + (optionally) email both parties.
- **Portal:** show profile completeness and recent leads; edits write **CLAIM**-provenance facts as `PENDING` for moderation.
- **Admin:** left-nav for Seeds, Dedupe, Queue, Snapshots, Facts, Signals, Match Tester.

---

## Middleware & RBAC

- Root-level `middleware.ts` matches `/admin/:path*` and `/portal/:path*` and checks session/role:

  - If not authed → redirect to `/sign-in` with callback URL
  - If authed but wrong role → redirect to `/403`
  - Uses try-catch around `auth()` for proper error handling

- `lib/rbac.ts` provides `hasRole(session, role)` for role checks.

- **Defense-in-depth:** Layouts for `admin/` and `portal/` are async server components that:
  - Call `auth()` to fetch session
  - Use `hasRole(session, 'admin'|'school')` to verify role
  - Redirect unauthorized users (duplicates middleware protection)

---

## API Pattern

- **Workers/cron:** keep REST routes (crawl, normalize, refresh).
- **Interactive:** use tRPC (see server routers) with Zod on every input.

---

## Environment Variables (`.env.example`)

```env
DATABASE_URL=
FIRECRAWL_API_KEY=
OPENAI_API_KEY=
RESEND_API_KEY=
NEXTAUTH_SECRET=
NEXTAUTH_URL=
```

---

## Acceptance (layout refactor)

- Visiting `/` → search → `/search` result list; clicking a card → `/schools/[id]`.
- Saving a school adds it to `/saved`.
- Compare tray adds items and renders `/compare`.
- Submitting contact on `/schools/[id]` inserts a `leads` row.
- A claimed school user can access `/portal` and view leads.
- An admin can access `/admin` tools; non-admin is blocked.
